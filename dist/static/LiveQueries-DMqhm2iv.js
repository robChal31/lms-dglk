import{cy as k,cz as V,cA as D,cB as T,cC as J,cD as U,cE as H,cF as z,b as P,r as b,ab as B,ac as K,a4 as F,j as $,ad as G,cG as Y,cH as x,cI as W,an as X,cJ as Z,cK as ee,cL as te}from"./sanity-I2A2J8WM.js";import{c as re,a as se}from"./PresentationToolGrantsCheck-_dEguoIO.js";import{i as L}from"./DisplayedDocumentBroadcaster-BJYKr3He.js";const ne=/^[a-z0-9_]+$/i;function ae(t){if(Array.isArray(t)&&t.includes("raw"))throw new TypeError('Invalid API perspective value: "raw". The raw-perspective can not be combined with other perspectives');const e=(Array.isArray(t)?t:[t]).filter(s=>typeof s!="string"||!ne.test(s));if(e.length>0){const s=e.map(i=>JSON.stringify(i));throw new TypeError(`Invalid API perspective value${e.length===1?"":"s"}: ${s.join(", ")}, expected \`published\`, \`drafts\`, \`raw\` or a release identifier string`)}}function ie(t){if(ae(t),Array.isArray(t))return t.includes("published")?t:[...t,"published"];switch(t){case"previewDrafts":case"drafts":return["drafts","published"];case"published":default:return["published"]}}function oe(t,e){const s=ie(e);function i(r){for(const n of s){let a=null;if(n.startsWith("r")&&(a=t({...r,_id:V(r._id,n)})),n==="drafts"&&(a=t({...r,_id:D(r._id)})),n==="published"&&(a=t({...r,_id:T(r._id)})),a)return{...a,_id:T(a._id),_originalId:a._id}}return null}return function(r){return i(r)}}function ue(t,e,s,i,r){var h,f;if(!e)return t;const n=oe(s,r),a=((f=(h=e.documents)==null?void 0:h.map)==null?void 0:f.call(h,n))||[];return k(JSON.parse(JSON.stringify(t)),(c,l)=>{const p=J(l,e);if(!p)return c;const{mapping:o,pathSuffix:S}=p;if(o.type!=="value"||o.source.type!=="documentValue")return c;const m=e.documents[o.source.document],I=e.paths[o.source.path];if(m){const E=U(I+S),v=H(E),w=a[o.source.document];if(!w)return c;const q=w?z(w,v,c):c;return c===q?c:i(q,{cachedDocument:w,previousValue:c,sourceDocument:m,sourcePath:E})}return c})}function ce(t,e){switch(e.type){case"message":return{...t,messages:[...t.messages,e]};case"reconnect":case"restart":return{...t,messages:[],resets:t.resets+1};case"welcome":return t;default:throw Error(`Unknown event: ${e.type}`,{cause:e})}}const le={messages:[],resets:0};function pe(t){const e=P.c(3),[s,i]=b.useReducer(ce,le),[r,n]=b.useState(null);if(r!==null)throw r;let a,h;return e[0]!==t.live?(a=()=>{const f=t.live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:i,error:c=>n(c instanceof Error?c:new Error("Unexpected error in useLiveEvents",{cause:c}))});return()=>f.unsubscribe()},h=[t.live],e[0]=t.live,e[1]=a,e[2]=h):(a=e[1],h=e[2]),b.useEffect(a,h),b.useDeferredValue(s)}const fe=(t,{previousValue:e})=>{if(typeof e=="string"){if(typeof t=="number")return`${t}`;if(Array.isArray(t)){if(t.length===0)return"";if(t.some(s=>typeof s=="object"&&ee(s)))return te(t)}}return t};function de(t,e,s){return`${t}:${e}:${JSON.stringify(s)}`}function he(t){if(t.queries.size<1)return t;const e=Date.now();if(!Array.from(t.heartbeats.values()).some(r=>r.heartbeat!==!1&&e>r.receivedAt+r.heartbeat))return t;const s=new Map,i=new Map;for(const[r,n]of t.heartbeats.entries())n.heartbeat!==!1&&e>n.receivedAt+n.heartbeat||(s.set(r,n),i.set(r,t.queries.get(r)));return{...t,queries:i,heartbeats:s}}function ye(t,{payload:e}){const s=de(e.perspective,e.query,e.params),i={query:e.query,params:e.params,perspective:e.perspective},r=new Map(t.heartbeats);r.set(s,{receivedAt:Date.now(),heartbeat:e.heartbeat});let n=t.queries;return(!t.queries.has(s)||!L(t.queries.get(s),i))&&(n=new Map(t.queries),n.set(s,i)),{heartbeats:r,queries:n}}function be(t,e){switch(e.type){case"query-listen":return ye(t,e);case"gc":return he(t);default:throw Error(`Unknown action: ${e.type}`,{cause:e})}}const me={queries:new Map,heartbeats:new Map};function Ee(){const t=P.c(4),[e,s]=b.useReducer(be,me);let i,r;t[0]===Symbol.for("react.memo_cache_sentinel")?(i=()=>{const h=setInterval(()=>s({type:"gc"}),Y);return()=>clearInterval(h)},r=[],t[0]=i,t[1]=r):(i=t[0],r=t[1]),b.useEffect(i,r);const n=b.useDeferredValue(e.queries);let a;return t[2]!==n?(a=[n,s],t[2]=n,t[3]=a):a=t[3],a}function Re(t){const e=P.c(31),{controller:s,perspective:i,onLoadersConnection:r,onDocumentsOnPage:n}=t,[a,h]=b.useState(),[f,c]=Ee(),l=B(),p=K();let o,S;e[0]!==s||e[1]!==p||e[2]!==c||e[3]!==n||e[4]!==r||e[5]!==l?(o=()=>{if(s){const R=s.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},re().provide({actors:se()}));return h(R),R.onStatus(r),R.on("loader/documents",g=>{g.projectId===l&&g.dataset===p&&n("loaders",g.perspective,g.documents)}),R.on("loader/query-listen",g=>{if(g.projectId===l&&g.dataset===p){if(typeof g.heartbeat=="number"&&g.heartbeat<x)throw new Error(`Loader query listen heartbeat interval must be at least ${x}ms`);c({type:"query-listen",payload:{perspective:g.perspective,query:g.query,params:g.params,heartbeat:g.heartbeat??!1}})}}),R.start()}return ge},S=[s,p,c,n,r,l],e[0]=s,e[1]=p,e[2]=c,e[3]=n,e[4]=r,e[5]=l,e[6]=o,e[7]=S):(o=e[6],S=e[7]),b.useEffect(o,S);let m;e[8]!==i?(m=Z(i)?W:{apiVersion:X},e[8]=i,e[9]=m):m=e[9];const I=F(m);let E,v;e[10]!==I?(v=I.withConfig({resultSourceMap:"withKeyArraySelector"}),e[10]=I,e[11]=v):v=e[11],E=v;const w=E;let q,_;e[12]!==i||e[13]!==a||e[14]!==p||e[15]!==l?(q=()=>{a&&a.post("loader/perspective",{projectId:l,dataset:p,perspective:i})},_=[a,i,l,p],e[12]=i,e[13]=a,e[14]=p,e[15]=l,e[16]=q,e[17]=_):(q=e[16],_=e[17]),b.useEffect(q,_);const M=b.useDeferredValue(t.liveDocument),A=pe(w);let y;e[18]!==f?(y=f.entries(),e[18]=f,e[19]=y):y=e[19];let u;e[20]!==y?(u=[...y],e[20]=y,e[21]=u):u=e[21];let d;return e[22]!==w||e[23]!==a||e[24]!==p||e[25]!==M||e[26]!==A.messages||e[27]!==A.resets||e[28]!==l||e[29]!==u?(d=$.jsx($.Fragment,{children:u.map(R=>{const[g,Q]=R,{query:j,params:N,perspective:O}=Q;return $.jsx(C,{projectId:l,dataset:p,perspective:O,query:j,params:N,comlink:a,client:w,liveDocument:M,liveEventsMessages:A.messages},`${A.resets}:${g}`)})}),e[22]=w,e[23]=a,e[24]=p,e[25]=M,e[26]=A.messages,e[27]=A.resets,e[28]=l,e[29]=u,e[30]=d):d=e[30],d}function ge(){}function ve(t){const e=P.c(20),{projectId:s,dataset:i,perspective:r,query:n,client:a,liveDocument:h,params:f,comlink:c,liveEventsMessages:l}=t,{result:p,resultSourceMap:o,syncTags:S}=we({client:a,liveDocument:h,params:f,perspective:r,query:n,liveEventsMessages:l})||{};let m;e[0]!==i||e[1]!==s?(m=(w,q,_,M,A,y,u)=>{w==null||w.post("loader/query-change",{projectId:s,dataset:i,perspective:q,query:_,params:M,result:A,resultSourceMap:y,tags:u})},e[0]=i,e[1]=s,e[2]=m):m=e[2];const I=G(m);let E;e[3]!==c||e[4]!==I||e[5]!==f||e[6]!==r||e[7]!==n||e[8]!==p||e[9]!==o||e[10]!==S?(E=()=>{o&&I(c,r,n,f,p,o,S)},e[3]=c,e[4]=I,e[5]=f,e[6]=r,e[7]=n,e[8]=p,e[9]=o,e[10]=S,e[11]=E):E=e[11];let v;return e[12]!==c||e[13]!==f||e[14]!==r||e[15]!==n||e[16]!==p||e[17]!==o||e[18]!==S?(v=[c,f,r,n,p,o,S],e[12]=c,e[13]=f,e[14]=r,e[15]=n,e[16]=p,e[17]=o,e[18]=S,e[19]=v):v=e[19],b.useEffect(E,v),null}const C=b.memo(ve);C.displayName="Memo(QuerySubscription)";function we(t){const e=P.c(30),{liveDocument:s,client:i,query:r,params:n,perspective:a,liveEventsMessages:h}=t,[f,c]=b.useState(null),[l,p]=b.useState(null),[o,S]=b.useState(void 0);let m;e[0]!==h?(m=()=>new Set(h.map(Se)),e[0]=h,e[1]=m):m=e[1];const[I]=b.useState(m);let E;if(e[2]!==h||e[3]!==I||e[4]!==o){let y;e[6]!==I?(y=R=>!I.has(R.id),e[6]=I,e[7]=y):y=e[7];const u=h.filter(y);let d;e[8]!==o?(d=R=>R.tags.some(g=>o==null?void 0:o.includes(g)),e[8]=o,e[9]=d):d=e[9],E=u.findLast(d),e[2]=h,e[3]=I,e[4]=o,e[5]=E}else E=e[5];const v=E==null?void 0:E.id,[w,q]=b.useState(null);if(w)throw w;let _,M;e[10]!==i||e[11]!==v||e[12]!==n||e[13]!==a||e[14]!==r?(_=()=>{const y=new AbortController;return i.fetch(r,n,{lastLiveEventId:v,tag:"presentation-loader",signal:y.signal,perspective:a,filterResponse:!1,returnQuery:!1}).then(u=>{b.startTransition(()=>{c(d=>L(d,u.result)?d:u.result),p(d=>L(d,u.resultSourceMap)?d:u.resultSourceMap),S(d=>L(d,u.syncTags)?d:u.syncTags)})}).catch(u=>{(typeof u!="object"||(u==null?void 0:u.name)!=="AbortError")&&q(u)}),()=>{y.abort()}},M=[i,v,n,a,r],e[10]=i,e[11]=v,e[12]=n,e[13]=a,e[14]=r,e[15]=_,e[16]=M):(_=e[15],M=e[16]),b.useEffect(_,M);let A;e:{if(s&&l){let u;e[17]!==s||e[18]!==a||e[19]!==f||e[20]!==l?(u=Ie(s,f,a,l),e[17]=s,e[18]=a,e[19]=f,e[20]=l,e[21]=u):u=e[21];let d;e[22]!==l||e[23]!==o||e[24]!==u?(d={result:u,resultSourceMap:l,syncTags:o},e[22]=l,e[23]=o,e[24]=u,e[25]=d):d=e[25],A=d;break e}let y;e[26]!==f||e[27]!==l||e[28]!==o?(y={result:f,resultSourceMap:l,syncTags:o},e[26]=f,e[27]=l,e[28]=o,e[29]=y):y=e[29],A=y}return A}function Se(t){return t.id}function Ie(t,e,s,i){if(s==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ue(e,i,r=>!r._projectId&&(t!=null&&t._id)&&T(t._id)===T(r._id)?typeof t._id=="string"&&typeof r._type=="string"?t:{...t,_id:t._id||r._id,_type:t._type||r._type}:null,fe,s)}export{Re as default,Ie as turboChargeResultIfSourceMap};
